name: Tests

on:
  push:
    branches:
      - main
      - 'release/*'
  pull_request:
    branches:
      - main
      - 'release/*'

jobs:
  check_changes:
    name: Check File Changes
    runs-on: ubuntu-latest
    outputs:
      has_python_changes: ${{ steps.changes.outputs.python }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - '**/*.py'
              - 'pyproject.toml'
              - 'poetry.lock'

  unit_tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.has_python_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --with dev

      - name: Run Tests with Coverage
        run: |
          echo "=== Running Unit Tests ==="
          poetry run pytest --cov=yid_py --cov-report=term-missing --cov-report=json --cov-fail-under=95

      - name: Report Coverage
        if: always()
        run: |
          if [ -f coverage.json ]; then
            coverage=$(python -c "import json; print(round(json.load(open('coverage.json'))['totals']['percent_covered'], 1))")
            if (( $(echo "$coverage >= 95" | bc -l) )); then
              echo "::notice::Test coverage: ${coverage}% (threshold: 95%)"
            else
              echo "::warning::Test coverage: ${coverage}% is below threshold of 95%"
            fi
          fi

  integration_tests:
    name: Integration Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.has_python_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Run Integration Tests
        run: |
          echo "=== Integration Tests for Python ${{ matrix.python-version }} ==="
          python -c "
          import sys
          print(f'Python version: {sys.version}')
          print()

          # Import package
          import yid_py
          print(f'yid_py version: {yid_py.__version__}')
          print()

          # Test 1: Basic encoding/decoding
          print('Test 1: Basic encoding/decoding')
          encoded = yid_py.to_alphanumeric(12345)
          decoded = yid_py.to_numeric(encoded)
          assert encoded == 'dnh', f'Expected dnh, got {encoded}'
          assert decoded == 12345, f'Expected 12345, got {decoded}'
          print(f'  12345 -> {encoded} -> {decoded} ✓')

          # Test 2: Zero and boundary values
          print('Test 2: Zero and boundary values')
          assert yid_py.to_alphanumeric(0) == 'a'
          assert yid_py.to_alphanumeric(61) == 'Z'
          assert yid_py.to_alphanumeric(62) == 'ba'
          print('  0 -> a, 61 -> Z, 62 -> ba ✓')

          # Test 3: Secure key
          print('Test 3: Secure key obfuscation')
          secure_encoded = yid_py.to_alphanumeric(12345, secure_key='secret')
          secure_decoded = yid_py.to_numeric(secure_encoded, secure_key='secret')
          assert secure_encoded != 'dnh', 'Secure encoding should differ'
          assert secure_decoded == 12345, f'Expected 12345, got {secure_decoded}'
          print(f'  12345 (secure) -> {secure_encoded} -> {secure_decoded} ✓')

          # Test 4: Transform
          print('Test 4: Case transformation')
          upper = yid_py.to_alphanumeric(12345, transform=yid_py.Transform.UPPER)
          lower = yid_py.to_alphanumeric(12345, transform=yid_py.Transform.LOWER)
          assert upper == 'DNH', f'Expected DNH, got {upper}'
          assert lower == 'dnh', f'Expected dnh, got {lower}'
          print(f'  UPPER: {upper}, LOWER: {lower} ✓')

          # Test 5: Encoder class
          print('Test 5: Encoder class')
          enc = yid_py.create(secure_key='test')
          enc_result = enc.encode(12345)
          dec_result = enc.decode(enc.encode_raw(12345))
          assert dec_result == 12345, f'Expected 12345, got {dec_result}'
          print(f'  Encoder: encode={enc_result}, decode={dec_result} ✓')

          # Test 6: Large numbers
          print('Test 6: Large numbers')
          large = 10**12
          large_encoded = yid_py.to_alphanumeric(large)
          large_decoded = yid_py.to_numeric(large_encoded)
          assert large_decoded == large, f'Expected {large}, got {large_decoded}'
          print(f'  {large} -> {large_encoded} -> {large_decoded} ✓')

          # Test 7: Roundtrip consistency
          print('Test 7: Roundtrip consistency')
          test_numbers = [0, 1, 100, 1000, 12345, 999999, 10**9]
          for num in test_numbers:
              result = yid_py.to_numeric(yid_py.to_alphanumeric(num))
              assert result == num, f'Roundtrip failed for {num}'
          print(f'  All {len(test_numbers)} roundtrips passed ✓')

          print()
          print('=== All integration tests passed! ===')
          "

  status:
    name: tests_passed
    runs-on: ubuntu-latest
    if: always()
    needs:
      - unit_tests
      - integration_tests
    steps:
      - name: Check job results
        run: |
          unit_result="${{ needs.unit_tests.result }}"
          integration_result="${{ needs.integration_tests.result }}"

          echo "Unit Tests: $unit_result"
          echo "Integration Tests: $integration_result"

          # Fail if any job failed
          if [[ "$unit_result" == "failure" ]] || [[ "$integration_result" == "failure" ]]; then
            echo "::error::Tests failed"
            exit 1
          fi

          # Success if all jobs passed or were skipped
          if [[ "$unit_result" == "success" || "$unit_result" == "skipped" ]] && \
             [[ "$integration_result" == "success" || "$integration_result" == "skipped" ]]; then
            echo "::notice::All tests passed"
            exit 0
          fi

          # Catch any unexpected state
          echo "::error::Unexpected job state"
          exit 1
